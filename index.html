<!-- index.html is github's main website page -->
<html>
  <head>
  <h1>test</h1>
  </head>
  <body>
    <!-- add embed for avasgpt demo here -->
    <!-- for python gradio embed use gradio-lite
  < tag . the gradio embed code is in app.py -->
    <!-- ykw, lets just use pyscript -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/pyscript.css" />
        <script defer src="https://pyscript.net/releases/2024.1.1/pyscript.js"></script>
<py-script>
  # avasgpt.github.io
## Version 1.0 Alpha
# we are gonna start by uploading packages from openai and gradio. Gradio is the main function for the app.
                                                                                                                   #WHERE ARE MY SECRETS!?
#!pip install \
 # pymilvus==2.3.4 \
  #langchain==0.0.352 \
  #openai==1.6.1 \
  #pytube==15.0.0 \
  #youtube-transcript-api==0.6.1 \
  #pyarrow==14.0.2 \
  #typing_extensions==4.9.0 \
  #gradio


import gradio as gr
import openai
import pandas as pd
from plotnine import (
    ggplot,
    geom_histogram,
    aes,
    theme,
    element_text,
    labs,
    coord_flip
)

from plotnine.themes.theme_classic import theme_classic
from pymilvus import (
    Collection,
    CollectionSchema,
    connections,
    DataType,
    FieldSchema,
    utility,
    MilvusClient
)

COLLECTION_NAME = 'youtube'
ZILLIZ_CLUSTER_URI = 'https://in03-28631759cefabda.api.gcp-us-west1.zillizcloud.com'  # Endpoint URI obtained from Zilliz Cloud
ZILLIZ_API_KEY = '0aeedf4f72823f9e03f08551302aa4d981854ee8af2f69a804a38e3df23f9753dddf40a313aecfeb8d4cb4789f2cd517204424e9'


connections.connect(uri=ZILLIZ_CLUSTER_URI, token=ZILLIZ_API_KEY, secure=True)

client = MilvusClient(
    uri=ZILLIZ_CLUSTER_URI,
    token=ZILLIZ_API_KEY)

openai_client = openai.OpenAI(api_key='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') #secret key! (do not use its expired)

# Extract embedding from text using OpenAI  string -> vector
# This function is directly from https://docs.zilliz.com/docs/similarity-search-with-zilliz-cloud-and-openai, but with "text-embedding-ada-002" added.
def create_embedding_from_string(text):
    return openai_client.embeddings.create(
        input=text,
        model='text-embedding-ada-002').data[0].embedding

def search_video_parts(query):

    results = client.search(
      collection_name=COLLECTION_NAME,
      data=[create_embedding_from_string(query)],  # Embeded search value
      search_params={ "metric_type": "IP" },
      limit=30,  # Limit to 30 results per search
      output_fields=['title', 'author', 'part_id', 'max_part_id', 'text'])  # Include title field in result


    # creating a list of the titles to make a dataframe for the histogram
    titles = []
    for result in results[0]:
      titles.append(
          [result['entity']['title']])
    # at this point, titles will look like:
    # [ ['Beginner - Data Science'], ['Beginner - Data Science'], ['20 Quick Tips'] ]

    # plotnine needs a dataframe!
    titles_dataframe = pd.DataFrame(data=titles, columns=['title'])

    p = ggplot(titles_dataframe, aes(x='title')) + \
      geom_histogram(binwidth=0.5,
                     colour="#000000",
                     fill='#ff007f',
                     position="identity") + \
      coord_flip() + \
      theme_classic() + \
      theme(axis_text_x=element_text(rotation=45, hjust=1)) + \
      labs(title='Frequency of Relevant Text Chunks')

    # Save the plot to an image and call it "image.png" Return this image name to gradio
    image_name = 'image.png'
    p.save(image_name)

    # Build a string with lots of info from the search response
    output_text = ''
    for result in results[0]:
      output_text += 'Title: ' + result['entity']['title'] + '\n'
      output_text += 'Author: ' + result['entity']['author'] + '\n'
      output_text += 'Excerpt:\n' + result['entity']['text'] + '\n\n'

    # Return multiple values, which gradio can display in separate boxes
    return image_name, output_text

#here is when we start the demo
demo = gr.Interface(
    fn=search_video_parts, # This is the function defined earlier in this block.
    inputs=gr.Textbox(label="Search query"),
    outputs= [
        gr.Image(label="histogram"), # The first thing returned is an image name
        gr.Textbox(label="details")  # The second thing returned is a string
</py-script>
  </body>
</html>
